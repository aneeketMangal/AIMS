--key points to note
-- 1. Course can now be offered by any other instructor (for same sem/year)
-- 2. Course must exist.
-- 3. Grades are character grades (A, A-, B, B-)

--On each entry in course_offering, 2 tables will be created
-- 1. Tickets corresponding to that course offering (security definer).
-- 2. Grades corresponding to that course offering.

--grade table creation trigger
CREATE OR REPLACE PROCEDURE create_grade_table()
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
declare
    table_name text;
    create_table_command text;
    grant_permission_command text;
begin
    table_name := concat(NEW.id,  '_grades');
    create_table_command := 'CREATE TABLE ' || table_name || ' (';
    create_table_command := create_table_command || ' student_id char(11) NOT NULL,';
    create_table_command := create_table_command || ' grade char(2) NOT NULL,';
    create_table_command := create_table_command || ' FOREIGN KEY(student_id) REFERENCES students(id));';
    
    EXECUTE create_table_command;

    grant_permission_command := 'GRANT ALL ON ' || table_name || ' TO deanoffice;';

    EXECUTE grant_permission_command;
end;
$$;

CREATE TRIGGER grade_table
AFTER INSERT
ON course_offering
FOR EACH ROW
EXECUTE PROCEDURE create_grade_table();

--ticket table creation trigger
CREATE OR REPLACE PROCEDURE create_instructor_ticket_table()
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
declare
    ins_id integer;
    table_name text;
    create_table_command text;
    grant_access_command text;
begin
    ins_id := NEW.insid;

    table_name := NEW.course_id || '_' || NEW.year || '_' || NEW.semester || '_tickets';
    create_table_command := 'CREATE TABLE ' || table_name || ' (';
    create_table_command := create_table_command || ' id INTEGER NOT NULL,';
    create_table_command := create_table_command || ' student_id char(11) NOT NULL,';
    create_table_command := create_table_command || ' course_id char(5) NOT NULL,';
    create_table_command := create_table_command || ' semester INTEGER NOT NULL,';
    create_table_command := create_table_command || ' year INTEGER NOT NULL,';
    create_table_command := create_table_command || ' PRIMARY KEY(id),';
    create_table_command := create_table_command || ' FOREIGN KEY student_id REFERENCES students(id),';
    create_table_command := create_table_command || ' FOREIGN KEY course_id REFERENCES courses(courseId));';
    EXECUTE create_table_command;

    grant_access_command := 'GRANT ALL ON ' || table_name ||' TO _' || ins_id || ';';
    EXECUTE grant_access_command;
end;$$;

CREATE TRIGGER instructor_ticket_table
BEFORE INSERT
ON course_offering
FOR EACH ROW
EXECUTE PROCEDURE create_instructor_ticket_table();

--constraint update procedure
CREATE OR REPLACE PROCEDURE update_constraint
(
    offering_id integer,
    batch_list varchar
)
LANGUAGE plpgsql
SECURITY INVOKER
AS $$
declare
    --split the batch list into a table of batches, and define a cursor for the table
    cur CURSOR FOR (SELECT batch FROM regexp_split_to_table(batch_list, E',') AS batch);
    batch_in_list varchar;
begin
    open cur;
    LOOP
        FETCH cur into batch_in_list;
        EXIT when not found;

        INSERT INTO batch_constraint(id, batch)
        VALUES
        (offering_id, batch_in_list);
    end LOOP;
    close cur;
end;$$;

GRANT EXECUTE
ON PROCEDURE update_constraint
TO faculty;

--procedure for offring courses
--batch_list to be provided as '2019csb,2020eeb,2018ceb'
CREATE OR REPLACE PROCEDURE offer_course
(
    course_id char(5),
    semester integer,
    year integer,
    batch_list varchar,
    slot char(6),
    classroom varchar,
    CGPA float8
)
LANGUAGE plpgsql
SECURITY INVOKER
AS $$
declare
    ins_id integer;
    offering_id integer;
begin
    ins_id := CAST(substr(user, 2) AS INTEGER);

    --if the course exists
    if EXISTS(SELECT 1 FROM courses WHERE courses.courseId = course_id) then
        
        --if the course is not offered this sem-year
        if NOT EXISTS(SELECT 1 FROM course_offering C WHERE C.course_id = course_id and C.semester = semester and C.year = year) then
            INSERT INTO course_offering(course_id, year, semester, insid, slot, classroom, CGPA)
            VALUES
            (course_id, year, semester, ins_id, slot, classroom, CGPA);

            SELECT count(*)
            INTO offering_id
            FROM course_offering;
            call update_constraint(offering_id, batch_list);
        
        --if the course is offered this sem-year
        else
            RAISE EXCEPTION 'Course % already offered.', course_id;
        END if;
    
    --if the course doesn't exist
    else
        RAISE EXCEPTION 'Course % does not exist.', course_id;
    END if;
end;$$;

GRANT EXECUTE
ON PROCEDURE offer_course
TO faculty;
